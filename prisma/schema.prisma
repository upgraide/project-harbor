// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  sessions      Session[]
  accounts      Account[]
  role          Role      @default(USER)
  disabled      Boolean   @default(false)

  // Investor-specific fields
  investorType      InvestorType?
  preferredLocation String?

  // Password management
  passwordChanged Boolean @default(false)

  // Extended investor/client fields
  companyName         String?
  representativeName String?
  phoneNumber         String?
  type                InvestorClientType?
  strategy1           InvestorStrategy?
  segment1            InvestorSegment?
  strategy2           InvestorStrategy?
  segment2            InvestorSegment?
  strategy3           InvestorStrategy?
  segment3            InvestorSegment?
  location1           String?
  location2           String?
  location3           String?
  minTicketSize       Float?
  maxTicketSize       Float?
  targetReturnIRR     Float?
  leadResponsibleId   String?
  leadMainContactId   String?
  leadResponsibleTeam TeamMember?
  leadMainContactTeam TeamMember?
  physicalAddress     String?
  website             String?
  lastContactDate     DateTime?
  acceptMarketingList Boolean?
  otherFacts          String?
  lastNotes           String?
  personalNotes       String?
  department          Department?

  // Relations for opportunity interactions
  mergerAndAcquisitionInterests UserMergerAndAcquisitionInterest[] @relation("userMergerAndAcquisitions")
  realEstateInterests           UserRealEstateInterest[]           @relation("userRealEstates")

  // Relations for opportunity assignments
  clientAcquisitionerMergerAndAcquisitions MergerAndAcquisition[]            @relation("clientAcquisitionerMergerAndAcquisitions")
  clientAcquisitionerRealEstates           RealEstate[]                      @relation("clientAcquisitionerRealEstates")
  clientOriginatorMergerAndAcquisitions    MergerAndAcquisition[]            @relation("clientOriginatorMergerAndAcquisitions")
  clientOriginatorRealEstates              RealEstate[]                      @relation("clientOriginatorRealEstates")
  accountManagerAssignments      OpportunityAccountManager[]
  
  // Relations for deal closing persons
  investedPersonDeals  OpportunityAnalytics[] @relation("InvestedPersonDeals")
  followupPersonDeals  OpportunityAnalytics[] @relation("FollowupPersonDeals")

  // CRM-specific fields for lead management
  leadSource          LeadSource?
  leadStatus          LeadStatus?        @default(NEW)
  leadPriority        LeadPriority?      @default(MEDIUM)
  tags                String[]           @default([])
  nextFollowUpDate    DateTime?
  leadScore           Int?               @default(0)
  convertedAt         DateTime?
  lostReason          String?
  lostAt              DateTime?
  commissionRate      Float?
  commissionNotes     String?

  // Lead relations
  leadResponsible   User?  @relation("LeadResponsibleUsers", fields: [leadResponsibleId], references: [id], onDelete: SetNull)
  leadMainContact   User?  @relation("LeadMainContactUsers", fields: [leadMainContactId], references: [id], onDelete: SetNull)
  leadResponsibleFor User[] @relation("LeadResponsibleUsers")
  leadMainContactFor User[] @relation("LeadMainContactUsers")
  notes             UserNote[]
  createdNotes      UserNote[] @relation("NoteCreator")
  
  // Last Follow-up relations
  lastFollowUps         LastFollowUp[]
  contactedByFollowUps  LastFollowUp[] @relation("ContactedBy")
  personContactedFollowUps LastFollowUp[] @relation("PersonContacted")
  activities        LeadActivity[]

  // Commission relations
  commissions Commission[]

  @@unique([email])
  @@map("user")
}

enum Role {
  USER
  TEAM
  ADMIN
}

enum InvestorType {
  LESS_THAN_10M
  BETWEEN_10M_100M
  GREATER_THAN_100M
}

enum InvestorClientType {
  ADVISOR
  ANGEL_INVESTOR
  BANK
  BRAND
  BROKER
  BUSINESS
  CLUB_DEAL_SYNDICATOR
  DEBT_FUND
  DEVELOPER
  FAMILY_OFFICE
  FUND_OF_FUND
  SEARCH_FUND
  INVESTOR
  PENSION_FUND
  PRIVATE_DEBT_INVESTOR
  PRIVATE_EQUITY_FUND
  SMALL_INVESTOR
  START_UP
  TEAM_MEMBER
  VENTURE_CAPITAL_FUND
  WEALTH_MANAGER
  CONSTRUCTION_COMPANY
  ASSET_MANAGER
  PARTNER
  ARCHITECT
  CONSULTANT
  PROMOTER
  OTHER
}

enum InvestorStrategy {
  AGNOSTIC
  MAJORITY_STAKES
  MINORITY_STAKES
  GROWTH
  BUSINESS_OPERATOR
  BUY_AND_HOLD
  CONSOLIDATION
  LEASE_AND_OPERATE
  SALE_AND_LEASEBACK
  CORE
  FIX_AND_FLIP
  REFURBISHMENT
  VALUE_ADD
  OPPORTUNISTIC
  DEVELOPMENT
  LONG_TERM_DEBT
  MEZZ_BRIDGE_DEBT
}

enum InvestorSegment {
  AGNOSTIC
  BUSINESS_SERVICES
  CONSTRUCTION_AND_REAL_ESTATE
  CONSTRUCTION_INDUSTRY
  CONSUMER_AND_RETAIL
  DATA_CENTER
  ENERGY_AND_INFRASTRUCTURE
  FINANCIAL_SERVICES
  FITNESS
  FOOD_INDUSTRY
  FOOD_RETAIL
  HEALTHCARE_AND_PHARMACEUTICALS
  IT
  TMT
  TRADING
  TRANSFORMATION_INDUSTRY
  TRANSPORTS
  MIXED
  HOSPITALITY
  LOGISTICS_AND_INDUSTRIAL
  OFFICE
  RESIDENTIAL
  SENIOR_LIVING
  SHOPPING_CENTERS
  STREET_RETAIL
  STUDENT_HOUSING
  DEBT
}

enum TeamMember {
  MAS
  FB
  FC
  FRS
  GBA
  JV
  JDV
  JG
  LM
  RS
  RA
  SM
  TE
  JCM
}

enum Department {
  MNA
  CRE
  MNA_AND_CRE
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model MergerAndAcquisition {
  id                 String  @id @default(cuid())
  name               String
  description        String?
  englishDescription String?

  // Basic fields
  images String[] // Array of image URLs/paths

  // Type and details
  type        Type?
  typeDetails TypeDetails?

  // Industry classification
  industry          Industry?
  industrySubsector IndustrySubsector?

  // Financial metrics
  sales            SalesRange?
  ebitda           EbitdaRange?
  ebitdaNormalized Float?
  netDebt          Float?

  // Graph data (stored as JSON)
  graphRows Json[] // Array of { year: string, revenue: number, ebitda: number, ebitdaMargin: number }
  graphUnit String  @default("millions") // "millions" or "thousands"

  // Growth metrics
  salesCAGR  Float?
  ebitdaCAGR Float?

  // Asset information
  assetIncluded       Boolean?
  estimatedAssetValue Float?

  preNDANotes String?

  // Post-NDA Fields
  shareholderStructure String[] // Array of file paths/URLs
  im                   String?
  entrepriseValue      Float?
  equityValue          Float?
  evDashEbitdaEntry    Float?
  evDashEbitdaExit     Float?
  ebitdaMargin         Float?
  fcf                  Float?
  netDebtDashEbitda    Float?
  capexItensity        Float?
  workingCapitalNeeds  Float?
  postNDANotes         String?

  // Co-Investment Fields
  coInvestment         Boolean?
  equityContribution   Float?
  grossIRR             Float?
  netIRR               Float?
  moic                 Float?
  cashOnCashReturn     Float?
  cashConvertion       Float?
  entryMultiple        Float?
  exitExpectedMultiple Float?
  holdPeriod           Float?

  userId    String // Who created the Merger and Acquisition
  status    OpportunityStatus @default(ACTIVE)
  hidden    Boolean           @default(false)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  // Client Acquisitioner and Account Managers
  clientAcquisitionerId String?
  clientAcquisitioner   User?   @relation("clientAcquisitionerMergerAndAcquisitions", fields: [clientAcquisitionerId], references: [id], onDelete: SetNull)

  // Client Originator (who brought the client)
  clientOriginatorId String?
  clientOriginator   User?   @relation("clientOriginatorMergerAndAcquisitions", fields: [clientOriginatorId], references: [id], onDelete: SetNull)

  // Relations
  analytics     OpportunityAnalytics?
  userInterests UserMergerAndAcquisitionInterest[] @relation("mergerAndAcquisitionUsers")
}

model RealEstate {
  id                 String  @id @default(cuid())
  name               String
  description        String?
  englishDescription String?

  // Images
  images String[] // Array of image URLs/paths

  // Asset type
  asset RealEstateAssetType?

  // Pre-NDA Fields
  nRoomsLastYear    Int?
  noi               Float?
  occupancyLastYear Float?
  walt              Float?
  nBeds             Int?
  investment        RealEstateInvestmentType?
  subRent           Float?
  rentPerSqm        Float?
  subYield          Float?
  capex             Float?
  capexPerSqm       Float?
  sale              Float?
  salePerSqm        Float?
  location          String?
  area              Float?
  value             Float?
  yield             Float?
  rent              Float?
  gcaAboveGround    Float?
  gcaBelowGround    Float?

  // Post-NDA Fields
  license                  String?
  irr                      Float?
  coc                      Float?
  licenseStage             String?
  holdingPeriod            Float?
  breakEvenOccupancy       Float?
  vacancyRate              Float?
  estimatedRentValue       Float?
  occupancyRate            Float?
  moic                     Float?
  price                    Float?
  totalInvestment          Float?
  profitOnCost             Float?
  profit                   Float?
  sofCosts                 Float?
  sellPerSqm               Float?
  gdv                      Float?
  wault                    Float?
  debtServiceCoverageRatio Float?
  expectedExitYield        Float?
  ltv                      Float?
  ltc                      Float?
  yieldOnCost              Float?

  // Co-Investment Fields
  coInvestment                   Boolean?
  gpEquityValue                  Float?
  gpEquityPercentage             Float?
  totalEquityRequired            Float?
  sponsorPresentation            String?
  promoteStructure               String?
  projectIRR                     Float?
  investorIRR                    Float?
  coInvestmentHoldPeriod         Float?
  coInvestmentBreakEvenOccupancy Float?

  createdBy String
  status    OpportunityStatus @default(ACTIVE)
  hidden    Boolean           @default(false)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  // Client Acquisitioner and Account Managers
  clientAcquisitionerId String?
  clientAcquisitioner   User?   @relation("clientAcquisitionerRealEstates", fields: [clientAcquisitionerId], references: [id], onDelete: SetNull)

  // Client Originator (who brought the client)
  clientOriginatorId String?
  clientOriginator   User?   @relation("clientOriginatorRealEstates", fields: [clientOriginatorId], references: [id], onDelete: SetNull)

  // Relations
  analytics     OpportunityAnalytics?
  userInterests UserRealEstateInterest[] @relation("realEstateUsers")

  @@map("real_estate")
}

model OpportunityAnalytics {
  id String @id @default(cuid())

  // Polymorphic relationship - one of these will be set
  mergerAndAcquisitionId String?               @unique
  mergerAndAcquisition   MergerAndAcquisition? @relation(fields: [mergerAndAcquisitionId], references: [id], onDelete: Cascade)

  realEstateId String?     @unique
  realEstate   RealEstate? @relation(fields: [realEstateId], references: [id], onDelete: Cascade)

  // Analytics metrics
  views Int @default(0)

  // Final Deal Values (when CONCLUDED)
  closed_at              DateTime?
  final_amount           Float?
  profit_amount          Float?
  commissionable_amount  Float?
  
  // Optional persons involved in deal closing
  invested_person_id String?
  invested_person    User?   @relation("InvestedPersonDeals", fields: [invested_person_id], references: [id], onDelete: SetNull)
  followup_person_id String?
  followup_person    User?   @relation("FollowupPersonDeals", fields: [followup_person_id], references: [id], onDelete: SetNull)

  // Future analytics fields can be added here:
  // uniqueViews Int @default(0)
  // downloads Int @default(0)
  // shares Int @default(0)
  // lastViewedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("opportunity_analytics")
}

// User Interest and NDA Tracking Models
model UserMergerAndAcquisitionInterest {
  id String @id @default(cuid())

  userId String
  user   User   @relation("userMergerAndAcquisitions", fields: [userId], references: [id], onDelete: Cascade)

  mergerAndAcquisitionId String
  mergerAndAcquisition   MergerAndAcquisition @relation("mergerAndAcquisitionUsers", fields: [mergerAndAcquisitionId], references: [id], onDelete: Cascade)

  // Interest status: true = interested, false = not interested
  interested Boolean @default(false)

  // Reason for not being interested
  notInterestedReason String?

  // NDA tracking
  ndaSigned Boolean @default(false)

  // Processed tracking: whether someone has looked at this interest
  processed Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, mergerAndAcquisitionId])
  @@map("user_m_and_a_interest")
}

model UserRealEstateInterest {
  id String @id @default(cuid())

  userId String
  user   User   @relation("userRealEstates", fields: [userId], references: [id], onDelete: Cascade)

  realEstateId String
  realEstate   RealEstate @relation("realEstateUsers", fields: [realEstateId], references: [id], onDelete: Cascade)

  // Interest status: true = interested, false = not interested
  interested Boolean @default(false)

  // Reason for not being interested
  notInterestedReason String?

  // NDA tracking
  ndaSigned Boolean @default(false)

  // Processed tracking: whether someone has looked at this interest
  processed Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, realEstateId])
  @@map("user_real_estate_interest")
}

// Enums for type safety
enum Type {
  BUY_IN
  BUY_OUT
  BUY_IN_BUY_OUT
}

enum TypeDetails {
  MAIORITARIO
  MINORITARIO
  FULL_OWNERSHIP
}

enum Industry {
  SERVICES
  TRANSFORMATION_INDUSTRY
  TRADING
  ENERGY_INFRASTRUCTURE
  FITNESS
  HEALTHCARE_PHARMACEUTICALS
  IT
  TMT
  TRANSPORTS
}

enum IndustrySubsector {
  BUSINESS_SERVICES
  FINANCIAL_SERVICES
  CONSTRUCTION_MATERIALS
  FOOD_BEVERAGES
  OTHERS
}

enum SalesRange {
  RANGE_0_5
  RANGE_5_10
  RANGE_10_15
  RANGE_20_30
  RANGE_30_PLUS
}

enum EbitdaRange {
  RANGE_1_2
  RANGE_2_3
  RANGE_3_5
  RANGE_5_PLUS
}

enum RealEstateAssetType {
  AGNOSTIC
  MIXED
  HOSPITALITY
  LOGISTICS_AND_INDUSTRIAL
  OFFICE
  RESIDENTIAL
  SENIOR_LIVING
  SHOPPING_CENTER
  STREET_RETAIL
  STUDENT_HOUSING
}

enum RealEstateInvestmentType {
  LEASE_AND_OPERATION
  S_AND_L
  CORE
  FIX_AND_FLIP
  REFURBISHMENT
  VALUE_ADD
  OPPORTUNISTIC
  DEVELOPMENT
}

model AccessRequest {
  id        String              @id @default(cuid())
  name      String
  email     String
  company   String
  phone     String
  position  String
  message   String
  status    AccessRequestStatus @default(PENDING)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  @@map("access_request")
}

enum AccessRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OpportunityStatus {
  ACTIVE
  INACTIVE
  CONCLUDED
}

enum OpportunityType {
  MNA
  REAL_ESTATE
}

model OpportunityAccountManager {
  id             String          @id @default(cuid())
  opportunityId  String
  opportunityType OpportunityType
  userId         String
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt      DateTime        @default(now())

  @@unique([opportunityId, opportunityType, userId])
  @@map("opportunity_account_manager")
}

model UserNote {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  note      String
  createdBy String
  createdByUser User @relation("NoteCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_note")
}

model LastFollowUp {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // The date of the follow-up (can be different from createdAt)
  followUpDate      DateTime
  
  // Description of the conversation/meeting
  description       String   @db.Text
  
  // Person who made the contact (from our team)
  contactedById     String
  contactedBy       User     @relation("ContactedBy", fields: [contactedById], references: [id], onDelete: Cascade)
  
  // Person who was contacted (the client/investor)
  personContactedId String
  personContacted   User     @relation("PersonContacted", fields: [personContactedId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("last_follow_up")
}

model LeadActivity {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  activityType  ActivityType
  title         String
  description   String?
  relatedUserId String?
  metadata      Json?
  createdAt     DateTime     @default(now())

  @@map("lead_activity")
}

enum LeadSource {
  WEBSITE
  REFERRAL
  COLD_OUTREACH
  NETWORKING_EVENT
  LINKEDIN
  EMAIL_CAMPAIGN
  PARTNER
  EXISTING_CLIENT
  ACCESS_REQUEST
  OTHER
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  MEETING_SCHEDULED
  PROPOSAL_SENT
  NEGOTIATION
  CONVERTED
  LOST
  ON_HOLD
  NURTURE
}

enum LeadPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  NOTE
  TASK
  DEAL_VIEWED
  DEAL_INTERESTED
  DEAL_NOT_INTERESTED
  STATUS_CHANGE
  ASSIGNMENT_CHANGE
  FOLLOW_UP_SCHEDULED
  OTHER
}

// Commission Management
model Commission {
  id                    String         @id @default(cuid())
  userId                String
  user                  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleType              CommissionRole
  commissionPercentage  Float          @default(0)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  // Relations to commission values
  commissionValues      CommissionValue[] @relation("CommissionToCommissionValue")

  @@unique([userId, roleType])
  @@map("commission")
}

model CommissionValue {
  id                    String              @id @default(cuid())
  
  // Project reference (polymorphic)
  opportunityId         String
  opportunityType       OpportunityType
  
  // Calculated commission value
  totalCommissionValue  Float?
  
  // Commission entries involved (many-to-many through relation)
  commissionId          String
  commission            Commission          @relation("CommissionToCommissionValue", fields: [commissionId], references: [id], onDelete: Cascade)
  
  // Payment schedule
  payments              CommissionPayment[]
  
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@unique([opportunityId, opportunityType, commissionId])
  @@map("commission_value")
}

model CommissionPayment {
  id                    String           @id @default(cuid())
  commissionValueId     String
  commissionValue       CommissionValue  @relation(fields: [commissionValueId], references: [id], onDelete: Cascade)
  
  // Payment installment number
  installmentNumber     Int
  
  // Percentage of total commission value for this payment
  percentage            Float?
  
  // Payment details (null until admin sets them)
  paymentDate           DateTime?
  paymentAmount         Float?
  
  // Payment status
  isPaid                Boolean          @default(false)
  paidAt                DateTime?
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@unique([commissionValueId, installmentNumber])
  @@map("commission_payment")
}

// Track commission resolution status per opportunity
model OpportunityCommissionSchedule {
  id                    String              @id @default(cuid())
  
  // Which opportunity this schedule belongs to
  opportunityId         String
  opportunityType       OpportunityType
  
  // Resolution status
  isResolved            Boolean             @default(false)
  resolvedAt            DateTime?
  resolvedBy            String?
  
  // Payment plan for this opportunity (shared by all commission recipients)
  paymentPlans          OpportunityPaymentPlan[]
  
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@unique([opportunityId, opportunityType])
  @@map("opportunity_commission_schedule")
}

// Payment plan template for an opportunity (applies to all recipients)
model OpportunityPaymentPlan {
  id                    String                          @id @default(cuid())
  scheduleId            String
  schedule              OpportunityCommissionSchedule   @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  
  // Installment details
  installmentNumber     Int
  percentage            Float  // Percentage of each person's total commission
  paymentDate           DateTime
  
  createdAt             DateTime                        @default(now())
  updatedAt             DateTime                        @updatedAt

  @@unique([scheduleId, installmentNumber])
  @@map("opportunity_payment_plan")
}

enum CommissionRole {
  ACCOUNT_MANAGER
  CLIENT_ACQUISITION
  CLIENT_ORIGINATOR
  DEAL_SUPPORT
}
